<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whole Tool: BMC & Chat</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="main-container">

    <div class="fullscreen-controls d-flex justify-content-between align-items-center p-1">
        <div style="visibility: hidden;"> 
             <button type="button" class="btn btn-sm btn-light me-1 mb-1" style="opacity: 0; pointer-events: none;"><i class="bi bi-printer"></i></button>
        </div>

        <div id="currentIndustryDisplay" class="current-industry-display">
            <span class="industry-icon me-1"></span> 
            <span class="industry-name">Select Industry</span>
            <i class="bi bi-chevron-down ms-1"></i>
        </div>

        <div class="control-buttons">
            <button type="button" class="btn btn-sm btn-light me-1 mb-1" id="helpBtn">
                <i class="bi bi-question-circle"></i>
            </button>
            <button type="button" class="btn btn-sm btn-light me-1 mb-1" id="printBtn">
                <i class="bi bi-printer"></i>
            </button>
            <button id="toggleFullscreenBtn" class="btn btn-sm btn-outline-secondary mb-1">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>
    </div>

    
    <div class="bmc-section" id="bmc-placeholder">
        <div id="industrySelectorOverlay">
            <div class="industry-selector-container">
                <h4 class="selector-header"><span class="header-emoji">ðŸŒ±</span> Select Your Industry</h4>
                <p class="text-muted">Choose the industry that best matches your business idea to get relevant guiding questions.</p>
                <div class="industry-selector-grid" id="industryGrid">
                    <div class="text-center p-5 w-100">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading Industries...
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center p-5" id="bmcLoadingIndicator" style="display: none;"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading Canvas...</div>
    </div>

    
    <div class="chat-section" id="chat-placeholder">
        
         <div class="text-center p-3"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading Chat...</div>
    </div>

</div>




<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/tooltip_manager.js"></script>
<script src="js/bmc_logic.js"></script>
<script src="js/chat_logic.js"></script>


<script>

let allQuestionsData = null;
let currentOpenBlockId = null;
let attachedCardInfo = null; 
let selectedIndustry = localStorage.getItem('selectedIndustry') || null; 

const industrySelectorOverlay = $('#industrySelectorOverlay');
const industryGrid = $('#industryGrid');
const bmcPlaceholder = $('#bmc-placeholder');
const bmcLoadingIndicator = $('#bmcLoadingIndicator');
const changeIndustryBtn = $('#changeIndustryBtn');
const currentIndustryDisplay = $('#currentIndustryDisplay');
const printBtn = $('#printBtn');
const helpBtn = $('#helpBtn');
const toggleFullscreenBtn = $('#toggleFullscreenBtn');


function populateIndustrySelector(industries) {
    industryGrid.empty(); 
    const industryList = [...industries.filter(ind => ind !== 'default').sort()]; 
    
    industryList.forEach(industry => {
        const formattedName = industry === 'Not specified' ? industry : industry.charAt(0).toUpperCase() + industry.slice(1).replace(/_/g, ' ');
        const cardHTML = `
            <div class="industry-card" data-industry="${industry}">
                ${formattedName} 
            </div>
        `;
        industryGrid.append(cardHTML);
    });
}


function animateControls(show) {
    const buttons = [printBtn, currentIndustryDisplay, helpBtn, toggleFullscreenBtn];
    const controlWaveDelay = 60; 

    buttons.forEach((button, index) => {
        
        if (button && button.length) {
            if (show) {
                const timer = setTimeout(() => {
                    button.addClass('visible');
                }, index * controlWaveDelay);
            } else {
                button.removeClass('visible');
            }
        } else if (button === currentIndustryDisplay) {
             console.warn("currentIndustryDisplay element not found during animation.");
        }
    });
}


function animateBmcCards(show) {
    const cards = bmcPlaceholder.find('.sbmc-card');
    const cardWaveDelay = 50; 

    if (show) {
        bmcPlaceholder.addClass('cards-visible'); 
        
        cards.each(function(index) {
            const card = $(this);
            card.css('transition-delay', `${index * cardWaveDelay}ms`);
        });
        
        
        const maxDelay = (cards.length - 1) * cardWaveDelay + 400; 
        setTimeout(() => {
            cards.css('transition-delay', '0ms');
        }, maxDelay);
    } else {
        
        cards.css('transition-delay', '0ms'); 
        bmcPlaceholder.removeClass('cards-visible');
    }
}


function loadBmcForIndustry(industry) {
    selectedIndustry = industry;
    localStorage.setItem('selectedIndustry', industry);
    console.log("Loading BMC for industry:", industry);
    
    
    industrySelectorOverlay.removeClass('visible');
    
    
    animateBmcCards(false);
    
    
    const formattedName = industry.charAt(0).toUpperCase() + industry.slice(1).replace(/_/g, ' ');
    currentIndustryDisplay.find('.industry-name').text(formattedName);
    currentIndustryDisplay.find('.industry-icon').html(getIndustryIcon(industry));
    
    
    setTimeout(() => {
        bmcLoadingIndicator.addClass('visible');
    }, 100); 

    
    $.get("bmc_partial.html").done(function(bmcHtml) {
        
        
        
        
        const currentBmcContent = bmcPlaceholder.find('.sbmc-container'); 
        
        
        bmcLoadingIndicator.removeClass('visible');

        
        if (currentBmcContent.length > 0) {
            console.log("Replacing existing BMC content.");
            currentBmcContent.replaceWith(bmcHtml);
        } else {
            console.log("Appending new BMC content.");
            
            bmcPlaceholder.append(bmcHtml); 
        }
        
        
        if (typeof initBmcLogic === 'function' && typeof updateAttachmentUI === 'function' && typeof clearAttachment === 'function') {
            console.log("Initializing BMC logic...");
            initBmcLogic(allQuestionsData, window.attachedCardInfo, window.currentOpenBlockId, updateAttachmentUI, clearAttachment, selectedIndustry);
        } else {
            console.error("initBmcLogic or chat UI functions not defined.");
            bmcPlaceholder.append("<div class='alert alert-danger'>Error initializing canvas logic.</div>");
        }

        
        animateControls(true);
        animateBmcCards(true);
        
        if (typeof introTour !== 'undefined') {
            introTour.initAfterIndustrySelection();
        }

    }).fail(function(bmcResponse, bmcStatus, bmcXhr) {
        bmcLoadingIndicator.removeClass('visible'); 
        
        bmcPlaceholder.children().not('#industrySelectorOverlay, #bmcLoadingIndicator').remove(); 
        bmcPlaceholder.append("<div class='alert alert-danger p-4'>Error loading Business Model Canvas for this industry. Please try again or select a different one.</div>");
        
        animateControls(false); 
    });
}


function showIndustrySelector() {
    bmcLoadingIndicator.removeClass('visible'); 
    industrySelectorOverlay.addClass('visible'); 
    
    
    animateControls(false); 
    animateBmcCards(false);

    
    if (selectedIndustry) {
        industryGrid.find('.industry-card').removeClass('selected');
        industryGrid.find(`.industry-card[data-industry="${selectedIndustry}"]`).addClass('selected');
    }
    console.log("Showing industry selector overlay.");
}
 
$(document).ready(function() {
    
    
    $.getJSON("questions.json").done(function(jsonData) {
        allQuestionsData = jsonData; 
        const availableIndustries = Object.keys(allQuestionsData);
        populateIndustrySelector(availableIndustries);

        
        if (selectedIndustry && allQuestionsData[selectedIndustry]) { 
            console.log("Found stored industry:", selectedIndustry);
            loadBmcForIndustry(selectedIndustry); 
                } else {
            console.log("No valid industry selected, showing selector.");
            if (selectedIndustry) {
                 localStorage.removeItem('selectedIndustry'); 
                 selectedIndustry = null;
            }
            
            animateControls(false);
            animateBmcCards(false); 
            showIndustrySelector();
        }

        }).fail(function(jqXHR, textStatus, errorThrown) {
        console.error("CRITICAL: Error loading questions.json: " + textStatus, errorThrown);
            
        industryGrid.html("<div class='alert alert-danger p-3'>Could not load industry data. Please try refreshing.</div>");
        showIndustrySelector(); 
            
        animateControls(false);
        animateBmcCards(false);
    });

    
    $("#chat-placeholder").load("chat_partial.html", function(chatResponse, chatStatus, chatXhr) {
        if (chatStatus == "error") {
            $(this).html("<div class='alert alert-danger'>Error loading Chat HTML: " + chatXhr.status + " " + chatXhr.statusText + "</div>");
            return;
        }

        if (typeof initChatLogic === 'function') {
             initChatLogic();
        } else {
             console.error("initChatLogic not defined. Ensure chat_logic.js is loaded correctly.");
        }
        
        if (typeof initTooltipLogic === 'function') {
            initTooltipLogic(document, '#currentIndustryDisplay', () => 'Change Industry');
            initTooltipLogic(document, '#printBtn', ($el) => $el.attr('data-original-title') || 'Print');
            initTooltipLogic(document, '#toggleFullscreenBtn', ($el) => $el.attr('data-original-title') || 'Enter Fullscreen');
            initTooltipLogic(document, '#helpBtn', ($el) => $el.attr('data-original-title') || 'Show Tour');
        } else {
            console.error("Tooltip Manager (initTooltipLogic) not found when initializing tooltips.");
        }
    });

    $(document).ready(function() {
        const $buttons = $('#printBtn, #helpBtn');
        
        $buttons.each(function() {
            const $btn = $(this);
            $btn.attr('data-original-title', $btn.attr('title'));
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                const ttInstance = bootstrap.Tooltip.getInstance(this);
                if (ttInstance) {
                    ttInstance.dispose();
                }
                const popInstance = bootstrap.Popover.getInstance(this);
                 if (popInstance) {
                    popInstance.dispose();
                }
            }
             $btn.removeAttr('title'); 
        });
        
        $('#toggleFullscreenBtn').attr('data-original-title', 'Enter Fullscreen');
        $('#helpBtn').attr('data-original-title', 'Show Tour');
    });

    
    
    industryGrid.on('click', '.industry-card', function() {
        const newlySelectedIndustry = $(this).data('industry');
        if (newlySelectedIndustry) {
             
             
             
             loadBmcForIndustry(newlySelectedIndustry);
        }
    });

    
    currentIndustryDisplay.on('click', function() {
        if(allQuestionsData) { 
             showIndustrySelector();
                } else {
            alert("Industry data failed to load. Cannot change industry.");
        }
    });

    
    
    

});

function getIndustryIcon(industry) {
    switch (industry) {
        case 'technology': return '<i class="bi bi-laptop"></i>';
        case 'finance': return '<i class="bi bi-bank"></i>';
        case 'healthcare': return '<i class="bi bi-heart-pulse"></i>';
        case 'retail': return '<i class="bi bi-shop"></i>';
        case 'food_service': return '<i class="bi bi-egg-fried"></i>';
        case 'education': return '<i class="bi bi-book"></i>';
        default: return '<i class="bi bi-buildings"></i>';
    }
}


function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
        });
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function handleFullscreenChange() {
    const fullscreenIcon = toggleFullscreenBtn.find('i');
    if (document.fullscreenElement) {
        $('body').addClass('fullscreen-active');
        fullscreenIcon.removeClass('bi-arrows-fullscreen').addClass('bi-arrows-angle-contract');
        toggleFullscreenBtn.attr('data-original-title', 'Exit Fullscreen');
        if (typeof initTooltipLogic === 'function') {
             initTooltipLogic(document, '#toggleFullscreenBtn', ($el) => $el.attr('data-original-title') || 'Toggle Fullscreen');
        }
    } else {
        $('body').removeClass('fullscreen-active');
        fullscreenIcon.removeClass('bi-arrows-angle-contract').addClass('bi-arrows-fullscreen');
        toggleFullscreenBtn.attr('data-original-title', 'Enter Fullscreen');
        if (typeof initTooltipLogic === 'function') {
             initTooltipLogic(document, '#toggleFullscreenBtn', ($el) => $el.attr('data-original-title') || 'Toggle Fullscreen');
        }
    }
}


document.addEventListener('fullscreenchange', handleFullscreenChange);

document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);


$(document).ready(function() {
    
    
    toggleFullscreenBtn.on('click', toggleFullscreen);
    
    $('#helpBtn').on('click', function() {
        if (typeof introTour !== 'undefined') {
            introTour.startTour();
        }
    });
    
    currentIndustryDisplay.on('click', function() {
         if(allQuestionsData) { 
              showIndustrySelector();
             initTooltipLogic(document, '#printBtn', ($el) => $el.attr('data-original-title') || 'Print');
             initTooltipLogic(document, '#toggleFullscreenBtn', ($el) => $el.attr('data-original-title') || 'Enter Fullscreen');
         } else {
             console.error("Tooltip Manager (initTooltipLogic) not found when initializing tooltips.");
         }
     });


     $(document).ready(function() {
         const $buttons = $('#printBtn, #helpBtn');
         
         $buttons.each(function() {
             const $btn = $(this);
             $btn.attr('data-original-title', $btn.attr('title'));
             if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                 const ttInstance = bootstrap.Tooltip.getInstance(this);
                 if (ttInstance) {
                     ttInstance.dispose();
                 }
                 const popInstance = bootstrap.Popover.getInstance(this);
                  if (popInstance) {
                     popInstance.dispose();
                 }
             }
              $btn.removeAttr('title'); 
         });
         
         $('#toggleFullscreenBtn').attr('data-original-title', 'Enter Fullscreen');
     });
});

</script>

<div id="questionTooltip" class="custom-tooltip"></div>


<script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
<script src="js/intro_tour.js"></script>
<script src="js/print.js"></script>

</body>
</html> 